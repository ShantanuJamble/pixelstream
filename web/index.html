<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PixelStream: Physics</title>
    <style>
        body { background: #222; color: #fff; text-align: center; font-family: sans-serif; }
        canvas { background: #000; border: 2px solid #555; margin-top: 20px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
    </style>
</head>
<body>
<h1>PixelStream: Remote Physics (C++ Authority)</h1>
<button onclick="startCall()" style="padding: 10px 20px; font-size: 1.2rem; cursor: pointer;">Connect & Play</button>
<br>
<canvas id="gameCanvas" width="800" height="600"></canvas>

<script>
    const signaling = new WebSocket('ws://localhost:8080');
    const pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
    const ctx = document.getElementById('gameCanvas').getContext('2d');
    let dataChannel = null;

    // Draw the ball
    function draw(x, y) {
        ctx.clearRect(0, 0, 800, 600);
        ctx.beginPath();
        ctx.arc(x, y, 20, 0, Math.PI * 2);
        ctx.fillStyle = "#3498db";
        ctx.fill();
    }

    signaling.onmessage = async (message) => {
        const data = JSON.parse(message.data);
        if (data.description) {
            await pc.setRemoteDescription(data.description);
        } else if (data.candidate) {
            await pc.addIceCandidate(data.candidate);
        }
    };

    pc.onicecandidate = (event) => {
        if (event.candidate) {
            signaling.send(JSON.stringify({
                candidate: event.candidate.candidate,
                sdpMid: event.candidate.sdpMid,
                sdpMLineIndex: event.candidate.sdpMLineIndex
            }));
        }
    };

    async function startCall() {
        dataChannel = pc.createDataChannel("game");

        // CRITICAL: Treat data as bytes, not text
        dataChannel.binaryType = "arraybuffer";

        dataChannel.onmessage = (event) => {
            // Parse 8 bytes (float x, float y)
            if (event.data.byteLength === 8) {
                const view = new DataView(event.data);
                const x = view.getFloat32(0, true); // true = Little Endian
                const y = view.getFloat32(4, true);
                draw(x, y);
            }
        };

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        signaling.send(JSON.stringify({ description: pc.localDescription }));
    }
</script>
</body>
</html>