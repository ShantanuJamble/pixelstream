<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PixelStream Client</title>
    <style>
        body { font-family: sans-serif; background: #222; color: #fff; text-align: center; padding-top: 50px; }
        #status { font-size: 1.5rem; color: #f39c12; }
        .success { color: #2ecc71 !important; }
    </style>
</head>
<body>
<h1>PixelStream Client</h1>
<div id="status">Connecting to Signaling...</div>
<br>
<button onclick="startCall()" style="padding: 10px 20px; font-size: 1.2rem;">Start Call</button>

<script>
    const signaling = new WebSocket('ws://localhost:8080');
    const pc = new RTCPeerConnection({
        iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
    });
    let dataChannel = null;

    // 1. WebSocket Signaling
    signaling.onopen = () => {
        document.getElementById('status').innerText = "Signaling Connected. Ready to Start.";
    };

    signaling.onmessage = async (message) => {
        const data = JSON.parse(message.data);
        if (data.description) {
            // If we get an Answer from C++, set it as remote description
            console.log("Received Answer from C++");
            await pc.setRemoteDescription(data.description);
        } else if (data.candidate) {
            // If we get an ICE candidate from C++, add it
            console.log("Received Candidate from C++");
            await pc.addIceCandidate(data.candidate);
        }
    };

    // 2. WebRTC Setup
    pc.onicecandidate = (event) => {
        if (event.candidate) {
            signaling.send(JSON.stringify({ candidate: event.candidate }));
        }
    };

    // 3. Start the process (Send Offer)
    async function startCall() {
        document.getElementById('status').innerText = "Creating Offer...";

        // Create Data Channel (This triggers 'on_data_channel' in C++)
        dataChannel = pc.createDataChannel("chat");
        setupDataChannel(dataChannel);

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        // Send Offer to C++ via Signaling
        signaling.send(JSON.stringify({ description: pc.localDescription }));
    }

    function setupDataChannel(dc) {
        dc.onopen = () => {
            document.getElementById('status').innerText = "Connected! (P2P Established)";
            document.getElementById('status').className = "success";
            dc.send("Hello from Browser!");
        };
        dc.onmessage = (e) => {
            console.log("Message from C++: " + e.data);
            alert("C++ says: " + e.data);
        };
    }
</script>
</body>
</html>